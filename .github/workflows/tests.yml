name: Backend Tests

on:
  push:
    branches: [ "main", "dev" ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ "main", "dev" ]
    paths:
      - 'backend/**'

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .

    services:
      # If we were using real Postgres:
      # postgres:
      #   image: postgres:15
      #   env:
      #     POSTGRES_DB: mambax_test
      #     POSTGRES_USER: user
      #     POSTGRES_PASSWORD: password
      #   ports:
      #     - 5432:5432
      # For now dealing with SQLite (in-memory) or simple tests
      
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install pytest pytest-asyncio httpx aiosqlite pytest-cov

    - name: Run Tests
      # Env vars for testing
      env:
        DATABASE_URL: sqlite+aiosqlite:///:memory:
        SECRET_KEY: "test_secret_key_must_be_long_enough_for_security_checks_32_chars"
        ENVIRONMENT: testing
        PYTHONPATH: "."
      run: |
        pytest backend/tests --cov=backend --cov-report=html --cov-fail-under=80
    
    - name: Archive code coverage results
      uses: actions/upload-artifact@v4
      with:
        name: code-coverage-report
        path: backend/htmlcov
